<!DOCTYPE html>
<html lang="ar" dir="rtl" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --main-bg: #f0f2f5; --card-bg: white; --text-color: #1f2937; --text-muted: #6b7280; --border-color: #e5e7eb; --primary-color: #4f46e5; }
        html.dark { --main-bg: #111827; --card-bg: #1f2937; --text-color: #f9fafb; --text-muted: #9ca3af; --border-color: #374151; }
        body { font-family: 'Cairo', sans-serif; background-color: var(--main-bg); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--card-bg); }
        .text-muted { color: var(--text-muted); }
        .border-color { border-color: var(--border-color); }
        .tab-link.active { background-color: var(--primary-color); color: white; }
        .modal-backdrop { background-color: rgba(0,0,0,0.5); }
        .progress-bar { background-color: var(--border-color); }
        .progress-bar-fill { background-color: var(--primary-color); }
        #login-page { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    </style>
</head>
<body>

    <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="login-page" class="min-h-screen flex flex-col items-center justify-center p-4 text-white text-center">
        <div class="max-w-md w-full">
            <h1 class="text-5xl font-extrabold mb-4">Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ù…Ø§Ù„ÙŠ</h1>
            <p class="text-lg opacity-90 mb-8">Ø£Ø³Ù‡Ù„ Ø·Ø±ÙŠÙ‚Ø© Ù„ØªØªØ¨Ø¹ Ø¯Ø®Ù„Ùƒ ÙˆÙ…ØµØ§Ø±ÙŠÙÙƒ.</p>
            
            <form id="login-form" class="space-y-4">
                <div id="new-user-view">
                    <input type="text" id="new-user-name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù„Ù„Ø¨Ø¯Ø¡" class="w-full p-4 rounded-lg text-gray-800 text-center text-lg" required>
                </div>
                <div id="returning-user-view" class="hidden space-y-4">
                    <h2 class="text-3xl font-bold">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ø¹ÙˆØ¯ØªÙƒØŒ <span id="returning-user-name"></span>!</h2>
                </div>
                <button type="submit" class="w-full bg-yellow-400 text-gray-900 font-bold py-4 rounded-lg text-lg hover:bg-yellow-500 transition-transform transform hover:scale-105">
                    Ø§Ù„Ø¯Ø®ÙˆÙ„
                </button>
            </form>
        </div>
    </div>

    <!-- ØµÙØ­Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© (Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹) -->
    <div id="app-page" class="hidden container mx-auto max-w-5xl p-4 sm:p-6">
        <header class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl sm:text-4xl font-extrabold text-indigo-500">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                <p class="text-muted mt-1">Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙƒØŒ <span id="user-name-display"></span>!</p>
            </div>
            <div class="flex items-center gap-4">
                <button id="dark-mode-toggle" class="p-2 rounded-full card shadow-sm">
                    <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="hidden"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
            </div>
        </header>

        <div id="tabs-container" class="card rounded-2xl shadow-md p-2 mb-6">
            <div class="flex flex-wrap justify-center" role="tablist">
                <button data-tab="dashboard" class="tab-link active flex-1 py-2 px-4 rounded-lg font-bold transition">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                <button data-tab="transactions" class="tab-link flex-1 py-2 px-4 rounded-lg font-bold transition">ğŸ’³ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</button>
                <button data-tab="goals" class="tab-link flex-1 py-2 px-4 rounded-lg font-bold transition">ğŸ¯ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù</button>
                <button data-tab="trash" class="tab-link flex-1 py-2 px-4 rounded-lg font-bold transition">ğŸ—‘ï¸ Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</button>
                <button data-tab="settings" class="tab-link flex-1 py-2 px-4 rounded-lg font-bold transition">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
            </div>
        </div>

        <main>
            <div id="dashboard" class="tab-content grid grid-cols-1 lg:grid-cols-3 gap-6"></div>
            <div id="transactions" class="tab-content hidden card rounded-2xl shadow p-6"></div>
            <div id="goals" class="tab-content hidden card rounded-2xl shadow p-6"></div>
            <div id="trash" class="tab-content hidden card rounded-2xl shadow p-6"></div>
            <div id="settings" class="tab-content hidden card rounded-2xl shadow p-6"></div>
        </main>
    </div>

    <!-- Modals -->
    <div id="transaction-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop"></div>
    <div id="goal-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop"></div>
    <div id="add-to-goal-modal" class="fixed inset-0 z-50 hidden items-center justify-center modal-backdrop"></div>

<script>
window.addEventListener('load', () => {
    // --- ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© ---
    let transactions = [], deletedTransactions = [], goals = [], settings = {};
    let monthlyComparisonChart;

    // --- Ø¥Ø¯Ø§Ø±Ø© Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    const loginPage = document.getElementById('login-page');
    const appPage = document.getElementById('app-page');
    const loginForm = document.getElementById('login-form');

    function checkLoginState() {
        const userName = localStorage.getItem('userName');
        if (userName) {
            settings.userName = userName;
            loginPage.classList.add('hidden');
            appPage.classList.remove('hidden');
            initializeApp();
        } else {
            loginPage.classList.remove('hidden');
            appPage.classList.add('hidden');
            const returningUserView = document.getElementById('returning-user-view');
            const newUserView = document.getElementById('new-user-view');
            returningUserView.classList.add('hidden');
            newUserView.classList.remove('hidden');
        }
    }

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const newUserNameInput = document.getElementById('new-user-name');
        let userName = localStorage.getItem('userName');
        if (!userName && newUserNameInput.value.trim()) {
            userName = newUserNameInput.value.trim();
            localStorage.setItem('userName', userName);
        }
        if (userName) {
            checkLoginState();
        }
    });

    // --- ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
    function initializeApp() {
        buildStaticUI();
        loadData();
        attachEventListeners();
        updateUI();
    }

    // --- ØªØ­Ù…ÙŠÙ„ ÙˆØ­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ---
    function loadData() {
        settings = JSON.parse(localStorage.getItem('settings')) || { theme: 'light' };
        settings.userName = localStorage.getItem('userName') || 'Ù…Ø³ØªØ®Ø¯Ù…';
        transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        deletedTransactions = JSON.parse(localStorage.getItem('deletedTransactions')) || [];
        goals = JSON.parse(localStorage.getItem('goals')) || [];
        
        document.documentElement.className = settings.theme;
        document.getElementById('user-name-display').textContent = settings.userName;
        document.getElementById('new-user-name-settings').value = settings.userName;
        document.getElementById('moon-icon').classList.toggle('hidden', settings.theme === 'dark');
        document.getElementById('sun-icon').classList.toggle('hidden', settings.theme === 'light');
    }

    function saveData() {
        localStorage.setItem('settings', JSON.stringify(settings));
        localStorage.setItem('transactions', JSON.stringify(transactions));
        localStorage.setItem('deletedTransactions', JSON.stringify(deletedTransactions));
        localStorage.setItem('goals', JSON.stringify(goals));
    }
    
    // --- Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ© ---
    function buildStaticUI() {
        document.getElementById('dashboard').innerHTML = `<div class="lg:col-span-3 grid grid-cols-1 md:grid-cols-3 gap-6"><div class="card rounded-2xl shadow p-6 text-center"><h3 class="text-lg font-bold text-muted">Ø±ØµÙŠØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</h3><p id="month-balance" class="text-4xl font-extrabold mt-2">0.00 â‚ª</p></div><div class="card rounded-2xl shadow p-6 text-center bg-green-100 dark:bg-green-900/50"><h3 class="text-lg font-bold text-green-600 dark:text-green-400">Ø¯Ø®Ù„ Ø§Ù„Ø´Ù‡Ø±</h3><p id="month-income" class="text-4xl font-extrabold mt-2 text-green-600 dark:text-green-300">0.00 â‚ª</p></div><div class="card rounded-2xl shadow p-6 text-center bg-red-100 dark:bg-red-900/50"><h3 class="text-lg font-bold text-red-600 dark:text-red-400">Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ø´Ù‡Ø±</h3><p id="month-expenses" class="text-4xl font-extrabold mt-2 text-red-600 dark:text-red-300">0.00 â‚ª</p></div></div><div class="lg:col-span-1 card rounded-2xl shadow p-6 space-y-4"><h3 class="text-xl font-bold">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø©</h3><div><h4 class="font-bold text-muted">Ø£Ø¹Ù„Ù‰ ÙØ¦Ø© Ø¥Ù†ÙØ§Ù‚</h4><p id="top-category" class="text-lg font-bold text-indigo-500">-</p></div><div><h4 class="font-bold text-muted">Ù…ØªÙˆØ³Ø· Ø§Ù„ØµØ±Ù Ø§Ù„ÙŠÙˆÙ…ÙŠ</h4><p id="avg-daily-spend" class="text-lg font-bold">0.00 â‚ª</p></div></div><div class="lg:col-span-2 card rounded-2xl shadow p-6"><h3 class="text-xl font-bold mb-4">Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ø§Ù„Ø´Ù‡Ø±ÙŠ</h3><canvas id="monthly-comparison-chart"></canvas></div>`;
        document.getElementById('transactions').innerHTML = `<div class="flex flex-col md:flex-row justify-between items-center mb-4"><h2 class="text-2xl font-bold">Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h2><button id="add-transaction-btn" class="w-full md:w-auto mt-4 md:mt-0 bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</button></div><div class="overflow-x-auto"><table class="w-full text-right"><thead class="border-b border-color"><tr class="text-muted"><th class="p-2">Ø§Ù„ÙˆØµÙ</th><th class="p-2">Ø§Ù„ÙØ¦Ø©</th><th class="p-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th class="p-2">Ø§Ù„Ù…Ø¨Ù„Øº</th><th class="p-2"></th></tr></thead><tbody id="transaction-table-body"></tbody></table></div>`;
        document.getElementById('goals').innerHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">Ø£Ù‡Ø¯Ø§Ù Ø§Ù„Ø§Ø¯Ø®Ø§Ø±</h2><button id="add-goal-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯</button></div><div id="goals-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>`;
        document.getElementById('trash').innerHTML = `<h2 class="text-2xl font-bold mb-4 border-b pb-4 border-color">Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª</h2><div><h3 class="text-lg font-bold mb-2">Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©</h3><ul id="deleted-transaction-list" class="space-y-3 h-80 overflow-y-auto pr-2"></ul></div>`;
        document.getElementById('settings').innerHTML = `<h2 class="text-2xl font-bold mb-6">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</h2><div class="space-y-8"><div class="card border border-color p-4 rounded-lg"><h3 class="text-lg font-bold mb-2">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­Ø³Ø§Ø¨</h3><div class="flex gap-2"><input type="text" id="new-user-name-settings" class="flex-grow p-2 rounded-lg border border-color bg-transparent"><button id="save-user-name" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg">Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…</button></div></div><div class="card border border-color p-4 rounded-lg"><h3 class="text-lg font-bold mb-2">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„ØªØµØ¯ÙŠØ±</h3><div class="grid grid-cols-1 sm:grid-cols-3 gap-4"><button id="export-excel-btn" class="bg-green-600 text-white font-bold py-3 px-4 rounded-lg">ØªØµØ¯ÙŠØ± Excel</button><button id="export-pdf-btn" class="bg-red-600 text-white font-bold py-3 px-4 rounded-lg">ØªØµØ¯ÙŠØ± PDF</button><button id="print-report-btn" class="bg-blue-600 text-white font-bold py-3 px-4 rounded-lg">Ø·Ø¨Ø§Ø¹Ø© ØªÙ‚Ø±ÙŠØ±</button></div></div><div class="card border border-red-500/50 p-4 rounded-lg"><h3 class="text-lg font-bold text-red-500">Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø®Ø·Ø±</h3><p class="text-muted my-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø£Ùˆ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p><div class="flex gap-4"><button id="logout-btn" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button><button id="reset-app-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button></div></div></div>`;
        document.getElementById('transaction-modal').innerHTML = `<div class="card rounded-2xl shadow-lg p-6 w-full max-w-md m-4"><h2 id="modal-title" class="text-2xl font-bold mb-4"></h2><form id="transaction-form" class="space-y-4"><input type="hidden" id="transaction-id"><input type="text" id="description" placeholder="Ø§Ù„ÙˆØµÙ" class="w-full p-3 border border-color rounded-lg bg-transparent" required><input type="number" id="amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" min="0.01" step="0.01" class="w-full p-3 border border-color rounded-lg bg-transparent" required><select id="type" class="w-full p-3 border border-color rounded-lg bg-transparent"><option value="expense">Ù…ØµØ±ÙˆÙ âŒ</option><option value="income">Ø¯Ø®Ù„ âœ…</option></select><select id="category" class="w-full p-3 border border-color rounded-lg bg-transparent"><option value="Ø·Ø¹Ø§Ù…">Ø·Ø¹Ø§Ù…</option><option value="Ù…ÙˆØ§ØµÙ„Ø§Øª">Ù…ÙˆØ§ØµÙ„Ø§Øª</option><option value="ØªØ±ÙÙŠÙ‡">ØªØ±ÙÙŠÙ‡</option><option value="ÙÙˆØ§ØªÙŠØ±">ÙÙˆØ§ØªÙŠØ±</option><option value="Ø±Ø§ØªØ¨">Ø±Ø§ØªØ¨</option><option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option></select><input type="date" id="date" class="w-full p-3 border border-color rounded-lg bg-transparent" required><div class="flex gap-4"><button type="submit" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-lg">Ø­ÙØ¸</button><button type="button" id="cancel-transaction-btn" class="flex-1 bg-gray-200 dark:bg-gray-600 font-bold py-3 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button></div></form></div>`;
        document.getElementById('goal-modal').innerHTML = `<div class="card rounded-2xl shadow-lg p-6 w-full max-w-md m-4"><h2 id="goal-modal-title" class="text-2xl font-bold mb-4"></h2><form id="goal-form" class="space-y-4"><input type="hidden" id="goal-id"><input type="text" id="goal-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‡Ø¯Ù" class="w-full p-3 border border-color rounded-lg bg-transparent" required><input type="number" id="goal-target" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù" min="1" class="w-full p-3 border border-color rounded-lg bg-transparent" required><input type="number" id="goal-current" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯Ø®Ø± Ø­Ø§Ù„ÙŠØ§Ù‹" min="0" value="0" class="w-full p-3 border border-color rounded-lg bg-transparent" required><div class="flex gap-4"><button type="submit" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-lg">Ø­ÙØ¸</button><button type="button" id="cancel-goal-btn" class="flex-1 bg-gray-200 dark:bg-gray-600 font-bold py-3 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button></div></form></div>`;
        document.getElementById('add-to-goal-modal').innerHTML = `<div class="card rounded-2xl shadow-lg p-6 w-full max-w-md m-4"><h2 class="text-2xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº Ù„Ù„Ù‡Ø¯Ù</h2><form id="add-to-goal-form" class="space-y-4"><input type="hidden" id="add-to-goal-id"><input type="number" id="add-to-goal-amount" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" min="0.01" step="0.01" class="w-full p-3 border border-color rounded-lg bg-transparent" required><div class="flex gap-4"><button type="submit" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-lg">Ø¥Ø¶Ø§ÙØ©</button><button type="button" id="cancel-add-to-goal-btn" class="flex-1 bg-gray-200 dark:bg-gray-600 font-bold py-3 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button></div></form></div>`;
    }

    // --- Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ---
    function attachEventListeners() {
        document.getElementById('dark-mode-toggle').addEventListener('click', toggleDarkMode);
        document.getElementById('add-transaction-btn').addEventListener('click', () => openTransactionModal());
        document.getElementById('cancel-transaction-btn').addEventListener('click', closeTransactionModal);
        document.getElementById('transaction-form').addEventListener('submit', handleTransactionForm);
        document.getElementById('add-goal-btn').addEventListener('click', () => openGoalModal());
        document.getElementById('cancel-goal-btn').addEventListener('click', closeGoalModal);
        document.getElementById('goal-form').addEventListener('submit', handleGoalForm);
        document.getElementById('cancel-add-to-goal-btn').addEventListener('click', closeAddToGoalModal);
        document.getElementById('add-to-goal-form').addEventListener('submit', handleAddToGoalForm);
        document.getElementById('save-user-name').addEventListener('click', saveUserName);
        document.getElementById('reset-app-btn').addEventListener('click', resetApp);
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('export-excel-btn').addEventListener('click', exportToExcel);
        document.getElementById('export-pdf-btn').addEventListener('click', exportToPDF);
        document.getElementById('print-report-btn').addEventListener('click', printReport);
        
        document.getElementById('tabs-container').addEventListener('click', (e) => {
            if (e.target.matches('.tab-link')) {
                openTab(e.target.dataset.tab);
            }
        });
        
        document.body.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action]');
            if (!button) return;
            const { action, id } = button.dataset;
            const actions = {
                'edit-transaction': () => openTransactionModal(id),
                'delete-transaction': () => deleteTransaction(id),
                'restore-transaction': () => restoreTransaction(id),
                'perm-delete-transaction': () => permanentlyDeleteTransaction(id),
                'edit-goal': () => openGoalModal(id),
                'delete-goal': () => deleteGoal(id),
                'add-to-goal': () => openAddToGoalModal(id),
            };
            if (actions[action]) actions[action]();
        });
    }

    // --- Ø¥Ø¯Ø§Ø±Ø© Modals ---
    const transactionModal = document.getElementById('transaction-modal');
    const goalModal = document.getElementById('goal-modal');
    const addToGoalModal = document.getElementById('add-to-goal-modal');
    function openModal(modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
    function closeModal(modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
    function openTransactionModal(id = null) {
        const form = document.getElementById('transaction-form');
        form.reset();
        document.getElementById('transaction-id').value = '';
        if (id) {
            const t = transactions.find(t => t.id === id);
            if (t) {
                document.getElementById('modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©';
                document.getElementById('transaction-id').value = t.id;
                document.getElementById('description').value = t.description;
                document.getElementById('amount').value = t.amount;
                document.getElementById('type').value = t.type;
                document.getElementById('category').value = t.category;
                document.getElementById('date').value = t.date;
            }
        } else {
            document.getElementById('modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©';
            setDefaultDate('date');
        }
        openModal(transactionModal);
    }
    function closeTransactionModal() { closeModal(transactionModal); }
    function openGoalModal(id = null) {
        const form = document.getElementById('goal-form');
        form.reset();
        document.getElementById('goal-id').value = '';
        if (id) {
            const g = goals.find(g => g.id === id);
            if (g) {
                document.getElementById('goal-modal-title').textContent = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‡Ø¯Ù';
                document.getElementById('goal-id').value = g.id;
                document.getElementById('goal-name').value = g.name;
                document.getElementById('goal-target').value = g.target;
                document.getElementById('goal-current').value = g.current;
            }
        } else {
            document.getElementById('goal-modal-title').textContent = 'Ø¥Ø¶Ø§ÙØ© Ù‡Ø¯Ù Ø¬Ø¯ÙŠØ¯';
        }
        openModal(goalModal);
    }
    function closeGoalModal() { closeModal(goalModal); }
    function openAddToGoalModal(id) {
        document.getElementById('add-to-goal-form').reset();
        document.getElementById('add-to-goal-id').value = id;
        openModal(addToGoalModal);
    }
    function closeAddToGoalModal() { closeModal(addToGoalModal); }

    // --- Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ---
    function handleTransactionForm(e) {
        e.preventDefault();
        const id = document.getElementById('transaction-id').value;
        const transactionData = {
            description: document.getElementById('description').value,
            amount: parseFloat(document.getElementById('amount').value),
            type: document.getElementById('type').value,
            category: document.getElementById('category').value,
            date: document.getElementById('date').value,
        };
        if (id) {
            const index = transactions.findIndex(t => t.id === id);
            if (index > -1) transactions[index] = { ...transactions[index], ...transactionData };
        } else {
            transactions.push({ id: crypto.randomUUID(), ...transactionData });
        }
        closeTransactionModal();
        updateUI();
    }
    function handleGoalForm(e) {
        e.preventDefault();
        const id = document.getElementById('goal-id').value;
        const goalData = {
            name: document.getElementById('goal-name').value,
            target: parseFloat(document.getElementById('goal-target').value),
            current: parseFloat(document.getElementById('goal-current').value) || 0,
        };
        if (id) {
            const index = goals.findIndex(g => g.id === id);
            if (index > -1) goals[index] = { ...goals[index], ...goalData };
        } else {
            goals.push({ id: crypto.randomUUID(), ...goalData });
        }
        closeGoalModal();
        updateUI();
    }
    function handleAddToGoalForm(e) {
        e.preventDefault();
        const id = document.getElementById('add-to-goal-id').value;
        const amount = parseFloat(document.getElementById('add-to-goal-amount').value);
        const goal = goals.find(g => g.id === id);
        if (goal && amount > 0) {
            goal.current = Math.min(goal.target, goal.current + amount);
        }
        closeAddToGoalModal();
        updateUI();
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ---
    function saveUserName() {
        const newName = document.getElementById('new-user-name-settings').value.trim();
        if (newName) {
            settings.userName = newName;
            localStorage.setItem('userName', newName);
            document.getElementById('user-name-display').textContent = newName;
            saveData();
            alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­!');
        }
    }
    function resetApp() {
        if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ.')) {
            localStorage.clear();
            location.reload();
        }
    }
    function logout() {
        localStorage.removeItem('userName');
        location.reload();
    }
    
    // --- Ø§Ù„ØªØµØ¯ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø© ---
    function exportToExcel() {
        if (transactions.length === 0) { alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.'); return; }
        const data = transactions.map(t => ({ 'Ø§Ù„ÙˆØµÙ': t.description, 'Ø§Ù„Ù…Ø¨Ù„Øº': t.amount, 'Ø§Ù„Ù†ÙˆØ¹': t.type === 'income' ? 'Ø¯Ø®Ù„' : 'Ù…ØµØ±ÙˆÙ', 'Ø§Ù„ÙØ¦Ø©': t.category, 'Ø§Ù„ØªØ§Ø±ÙŠØ®': new Date(t.date).toLocaleDateString('ar-AE') }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª");
        XLSX.writeFile(wb, "ØªÙ‚Ø±ÙŠØ±_Ù…Ø§Ù„ÙŠ.xlsx");
    }
    async function exportToPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.text("Financial Report", 10, 10);
        doc.autoTable({
            head: [['Date', 'Description', 'Category', 'Type', 'Amount']],
            body: transactions.map(t => [new Date(t.date).toLocaleDateString(), t.description, t.category, t.type, t.amount.toFixed(2)]),
        });
        doc.save('report.pdf');
    }
    function printReport() {
        const printWindow = window.open('', '', 'height=600,width=800');
        printWindow.document.write('<html><head><title>Print Report</title>');
        printWindow.document.write('<style>body{font-family:sans-serif; direction: rtl;} table{width:100%; border-collapse:collapse;} th,td{border:1px solid #ddd; padding: 8px;}</style></head><body>');
        printWindow.document.write('<h1>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</h1>');
        printWindow.document.write('<table"><thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>');
        transactions.forEach(t => {
            printWindow.document.write(`<tr><td>${new Date(t.date).toLocaleDateString()}</td><td>${t.description}</td><td>${t.amount.toFixed(2)}</td></tr>`);
        });
        printWindow.document.write('</tbody></table></body></html>');
        printWindow.document.close();
        printWindow.print();
    }
    
    // --- Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Render) ---
    function renderTransactions() {
        const tbody = document.getElementById('transaction-table-body');
        tbody.innerHTML = '';
        const filtered = transactions;
        if (filtered.length === 0) {
            tbody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª.</td></tr>`;
            return;
        }
        filtered.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t => {
            const row = document.createElement('tr');
            row.className = 'border-b border-color';
            row.innerHTML = `<td class="p-2 font-bold">${t.description}</td><td class="p-2 text-muted">${t.category}</td><td class="p-2 text-muted">${new Date(t.date).toLocaleDateString('ar-AE')}</td><td class="p-2 font-bold ${t.type === 'income' ? 'text-green-500' : 'text-red-500'}">${t.amount.toFixed(2)} â‚ª</td><td class="p-2 flex gap-2"><button data-action="edit-transaction" data-id="${t.id}" class="text-blue-500 hover:underline">ØªØ¹Ø¯ÙŠÙ„</button><button data-action="delete-transaction" data-id="${t.id}" class="text-red-500 hover:underline">Ø­Ø°Ù</button></td>`;
            tbody.appendChild(row);
        });
    }
    function renderGoals() {
        const list = document.getElementById('goals-list');
        list.innerHTML = '';
        if (goals.length === 0) {
            list.innerHTML = `<p class="text-muted col-span-full text-center py-8">Ù„Ù… ØªÙ‚Ù… Ø¨Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø£Ù‡Ø¯Ø§Ù Ø¨Ø¹Ø¯.</p>`;
            return;
        }
        goals.forEach(g => {
            const percentage = Math.min((g.current / g.target) * 100, 100);
            const card = document.createElement('div');
            card.className = 'card border border-color p-4 rounded-lg space-y-3 flex flex-col';
            card.innerHTML = `<div class="flex-grow"><div class="flex justify-between items-start"><div><h3 class="text-xl font-bold">${g.name}</h3><p class="font-bold text-indigo-500">${g.current.toFixed(2)} / ${g.target.toFixed(2)} â‚ª</p></div><div class="text-lg font-bold">${percentage.toFixed(1)}%</div></div><div class="w-full progress-bar rounded-full h-4 mt-2"><div class="progress-bar-fill h-4 rounded-full" style="width: ${percentage}%"></div></div></div><div class="flex gap-2 pt-2 border-t border-color mt-3"><button data-action="add-to-goal" data-id="${g.id}" class="flex-1 bg-green-500 text-white text-sm font-bold py-2 px-3 rounded-lg">Ø¥Ø¶Ø§ÙØ© Ù…Ø¨Ù„Øº</button><button data-action="edit-goal" data-id="${g.id}" class="flex-1 bg-gray-200 dark:bg-gray-600 text-sm font-bold py-2 px-3 rounded-lg">ØªØ¹Ø¯ÙŠÙ„</button><button data-action="delete-goal" data-id="${g.id}" class="flex-1 bg-red-500 text-white text-sm font-bold py-2 px-3 rounded-lg">Ø­Ø°Ù</button></div>`;
            list.appendChild(card);
        });
    }
    function renderTrash() {
        const list = document.getElementById('deleted-transaction-list');
        list.innerHTML = '';
        if (deletedTransactions.length === 0) {
            list.innerHTML = `<li class="text-center text-muted py-4">Ø³Ù„Ø© Ø§Ù„Ù…Ù‡Ù…Ù„Ø§Øª ÙØ§Ø±ØºØ©.</li>`;
        } else {
            deletedTransactions.forEach(t => {
                const li = document.createElement('li');
                li.className = 'p-3 rounded-lg card border border-color flex justify-between items-center';
                li.innerHTML = `<div><p class="font-bold">${t.description}</p><p class="text-sm text-muted">${t.amount.toFixed(2)} â‚ª</p></div><div class="flex gap-2"><button data-action="restore-transaction" data-id="${t.id}" class="text-green-500 hover:underline">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button><button data-action="perm-delete-transaction" data-id="${t.id}" class="text-red-500 hover:underline">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button></div>`;
                list.appendChild(li);
            });
        }
    }

    // --- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© ---
    function updateDashboard() {
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        const monthTransactions = transactions.filter(t => new Date(t.date) >= startOfMonth);
        const monthIncome = monthTransactions.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
        const monthExpenses = monthTransactions.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
        document.getElementById('month-income').textContent = `${monthIncome.toFixed(2)} â‚ª`;
        document.getElementById('month-expenses').textContent = `${monthExpenses.toFixed(2)} â‚ª`;
        document.getElementById('month-balance').textContent = `${(monthIncome - monthExpenses).toFixed(2)} â‚ª`;
        const expenseByCategory = monthTransactions.filter(t => t.type === 'expense').reduce((acc, t) => { acc[t.category] = (acc[t.category] || 0) + t.amount; return acc; }, {});
        const topCategory = Object.keys(expenseByCategory).sort((a, b) => expenseByCategory[b] - expenseByCategory[a])[0];
        document.getElementById('top-category').textContent = topCategory || '-';
        const avgDailySpend = monthExpenses / (now.getDate());
        document.getElementById('avg-daily-spend').textContent = `${avgDailySpend > 0 ? avgDailySpend.toFixed(2) : '0.00'} â‚ª`;
        renderMonthlyComparisonChart();
    }
    
    function renderMonthlyComparisonChart() {
        const ctx = document.getElementById('monthly-comparison-chart').getContext('2d');
        const labels = [];
        const data = [];
        for (let i = 5; i >= 0; i--) {
            const d = new Date();
            d.setMonth(d.getMonth() - i);
            labels.push(d.toLocaleString('ar', { month: 'long' }));
            const monthStart = new Date(d.getFullYear(), d.getMonth(), 1);
            const monthEnd = new Date(d.getFullYear(), d.getMonth() + 1, 0);
            const monthExpenses = transactions.filter(t => t.type === 'expense' && new Date(t.date) >= monthStart && new Date(t.date) <= monthEnd).reduce((s, t) => s + t.amount, 0);
            data.push(monthExpenses);
        }
        if (monthlyComparisonChart) monthlyComparisonChart.destroy();
        monthlyComparisonChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ', data, backgroundColor: '#4f46e5', borderRadius: 5 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: 'rgba(128, 128, 128, 0.2)' } }, x: { grid: { display: false } } } }
        });
    }

    // --- Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ---
    function toggleDarkMode() {
        settings.theme = document.documentElement.classList.toggle('dark') ? 'dark' : 'light';
        document.getElementById('moon-icon').classList.toggle('hidden');
        document.getElementById('sun-icon').classList.toggle('hidden');
        saveData();
        updateDashboard();
    }

    // --- Ø§Ù„ØªØ­ÙÙŠØ² ---
    function showDailyQuote() {
        const quotes = ["ÙˆÙØ± Ø§Ù„ÙŠÙˆÙ…â€¦ ØªØ³ØªÙ…ØªØ¹ ØºØ¯Ø§Ù‹", "Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø£Ù…ÙˆØ§Ù„Ùƒ Ù‡Ùˆ Ø£ÙˆÙ„ Ø®Ø·ÙˆØ© Ù„Ù„Ø­Ø±ÙŠØ©"];
        // This element is removed, so we check for its existence
        // const quoteEl = document.getElementById('motivational-quote');
        // if (quoteEl) quoteEl.textContent = quotes[Math.floor(Math.random() * quotes.length)];
    }
    
    // --- Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    function updateUI() {
        renderTransactions();
        renderGoals();
        renderTrash();
        updateDashboard();
        saveData();
    }
    
    function openTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.querySelectorAll('.tab-link').forEach(link => link.classList.remove('active'));
        document.getElementById(tabName).classList.remove('hidden');
        document.querySelector(`.tab-link[data-tab="${tabName}"]`).classList.add('active');
    }
    
    function setDefaultDate(elementId) {
        const dateInput = document.getElementById(elementId);
        if(dateInput) dateInput.value = new Date().toISOString().split('T')[0];
    }

    // --- Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ---
    checkLoginState();
});
</script>
</body>
</html>